<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alt-Text Generator</title>
  <style>
    :root {
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --bg-secondary: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --accent: #8b5cf6;
      --success: #10b981;
      --success-bg: #ecfdf5;
      --warning: #f59e0b;
      --warning-bg: #fffbeb;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text-primary); line-height: 1.5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .header h1 { font-size: 24px; font-weight: 700; }
    .header-actions { display: flex; gap: 12px; }
    
    .stats-bar { display: flex; gap: 24px; margin-bottom: 24px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; flex-wrap: wrap; }
    .stat-value { font-size: 24px; font-weight: 700; }
    .stat-value.warning { color: var(--warning); }
    .stat-value.success { color: var(--success); }
    .stat-label { font-size: 13px; color: var(--text-muted); }
    
    .alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 24px; }
    .alert.warning { background: var(--warning-bg); border: 1px solid var(--warning); color: #92400e; }
    .alert.info { background: #eff6ff; border: 1px solid #3b82f6; color: #1e40af; }
    
    .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .image-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .image-preview { width: 100%; height: 180px; object-fit: cover; background: var(--bg-secondary); }
    .image-info { padding: 16px; }
    .image-filename { font-weight: 600; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .image-meta { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    .image-status { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; padding: 4px 8px; border-radius: 4px; margin-bottom: 12px; }
    .image-status.missing { background: var(--warning-bg); color: var(--warning); }
    .image-status.has-alt { background: var(--success-bg); color: var(--success); }
    
    .alt-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; resize: vertical; min-height: 60px; font-family: inherit; }
    .alt-preview { background: var(--bg-secondary); padding: 10px 12px; border-radius: 8px; font-size: 13px; color: var(--text-secondary); }
    
    .btn { padding: 8px 16px; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-secondary { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-block { width: 100%; justify-content: center; }
    
    .image-actions { display: flex; gap: 8px; margin-top: 12px; }
    
    .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 24px; }
    .page-btn { width: 36px; height: 36px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); cursor: pointer; }
    .page-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .setup-card { max-width: 500px; margin: 60px auto; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; }
    .form-group input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
    .error-msg { color: var(--danger); font-size: 13px; margin-top: 8px; }
    
    .loading { display: flex; align-items: center; justify-content: center; padding: 60px; }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-icon { font-size: 48px; margin-bottom: 12px; }
    
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--text-primary); color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; z-index: 1000; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    
    .filter-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
    .filter-tab { padding: 8px 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); cursor: pointer; font-size: 13px; }
    .filter-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
    
    /* Progress Modal */
    .progress-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .progress-card { background: var(--bg-card); border-radius: 16px; padding: 32px; width: 90%; max-width: 500px; text-align: center; }
    .progress-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .progress-subtitle { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; }
    .progress-bar-container { background: var(--bg-secondary); border-radius: 8px; height: 12px; overflow: hidden; margin-bottom: 16px; }
    .progress-bar { background: linear-gradient(90deg, var(--accent), #a78bfa); height: 100%; border-radius: 8px; transition: width 0.3s ease; }
    .progress-stats { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-secondary); margin-bottom: 24px; }
    .progress-eta { font-size: 14px; color: var(--text-muted); margin-bottom: 24px; }
    .progress-actions { display: flex; gap: 12px; justify-content: center; }
    
    .free-badge { display: inline-block; background: #dcfce7; color: #166534; font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
  </style>
</head>
<body>
  <div id="app">
    <div id="setup-view" class="container">
      <div class="setup-card">
        <h2 style="margin-bottom: 8px;">üñºÔ∏è Alt-Text Generator</h2>
        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">
          Generate AI-powered alt text for images missing accessibility descriptions.
        </p>
        
        <div class="form-group" id="endpoint-group" style="display: none;">
          <label>Hygraph Content API Endpoint</label>
          <input type="text" id="endpoint-input" placeholder="https://...hygraph.com/content/.../master">
          <div class="form-hint">Auto-detected when running inside Hygraph</div>
        </div>
        
        <div class="form-group" id="token-group" style="display: none;">
          <label>Hygraph Auth Token (PAT)</label>
          <input type="password" id="token-input" placeholder="eyJ...">
          <div class="form-hint">Shared with other Hygraph tools. Only needed once.</div>
        </div>
        
        <div class="form-group">
          <label>Google Gemini API Key <span class="free-badge">FREE</span></label>
          <input type="password" id="gemini-input" placeholder="AIza...">
          <div class="form-hint">Free tier: 1,500 requests/day. <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--accent);">Get one here</a></div>
        </div>
        
        <button class="btn btn-primary btn-block" id="connect-btn" style="margin-top: 20px;">
          Connect & Scan Images
        </button>
        <div id="setup-error" class="error-msg"></div>
      </div>
    </div>
    
    <div id="main-view" class="container" style="display: none;">
      <div class="header">
        <h1>üñºÔ∏è Alt-Text Generator</h1>
        <div class="header-actions">
          <button class="btn btn-secondary" id="refresh-btn">üîÑ Refresh</button>
          <button class="btn btn-primary" id="generate-all-btn">‚ú® Generate All Missing</button>
        </div>
      </div>
      
      <div id="no-alt-field-alert" class="alert warning" style="display:none;">
        <strong>‚ö†Ô∏è No alt text field found on Asset model!</strong><br>
        Add a String field (alt, altText, description, or caption) to your Asset model.
      </div>
      
      <div id="rate-limit-info" class="alert info" style="display:none;">
        <strong>‚ÑπÔ∏è Free Tier Rate Limiting</strong><br>
        Gemini free tier allows 15 requests/minute. Bulk generation uses 4-second delays between images.
      </div>
      
      <div id="field-info" style="margin-bottom:16px;font-size:13px;color:var(--text-muted);"></div>
      
      <div class="stats-bar">
        <div class="stat">
          <div class="stat-value" id="total-images">-</div>
          <div class="stat-label">Total Images</div>
        </div>
        <div class="stat">
          <div class="stat-value warning" id="missing-alt">-</div>
          <div class="stat-label">Missing Alt Text</div>
        </div>
        <div class="stat">
          <div class="stat-value success" id="has-alt">-</div>
          <div class="stat-label">Has Alt Text</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="coverage">-</div>
          <div class="stat-label">Coverage</div>
        </div>
      </div>
      
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="missing">‚ö†Ô∏è Missing Alt Text</button>
        <button class="filter-tab" data-filter="has">‚úÖ Has Alt Text</button>
        <button class="filter-tab" data-filter="all">üì∑ All Images</button>
      </div>
      
      <div id="images-container">
        <div class="loading"><div class="spinner"></div></div>
      </div>
      
      <div class="pagination" id="pagination"></div>
    </div>
    
    <!-- Progress Modal -->
    <div id="progress-modal" class="progress-modal" style="display: none;">
      <div class="progress-card">
        <div class="progress-title">‚ú® Generating Alt Text</div>
        <div class="progress-subtitle" id="progress-current">Processing image...</div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
        <div class="progress-stats">
          <span id="progress-count">0 / 0</span>
          <span id="progress-percent">0%</span>
        </div>
        <div class="progress-eta" id="progress-eta">Estimated time: calculating...</div>
        <div class="progress-actions">
          <button class="btn btn-secondary" id="pause-btn">‚è∏Ô∏è Pause</button>
          <button class="btn btn-danger" id="cancel-btn">‚úñÔ∏è Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import "https://unpkg.com/@graphcms/zoid@9.0.64-alpha.1/lib/zoid.min.js";
    import "https://unpkg.com/@hygraph/app-sdk";
    
    const sdk = window["@hygraph/app-sdk"];
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    
    let endpoint = null, token = null, geminiKey = null;
    let allImages = [], filteredImages = [];
    let currentFilter = 'missing', currentPage = 1;
    let altFieldName = null;
    const PAGE_SIZE = 12;
    const RATE_LIMIT_DELAY = 4000; // 4 seconds between requests (15 RPM = 4s)
    
    // Bulk generation state
    let bulkGenerating = false;
    let bulkPaused = false;
    let bulkCancelled = false;
    let completedIds = new Set();
    
    // Simple storage - ONE PAT shared across all tools
    const PAT_KEY = 'hygraph_tools_pat';
    const ENDPOINT_KEY = 'hygraph_tools_endpoint';
    const GEMINI_KEY = 'hygraph_tools_gemini';
    const PROGRESS_KEY = 'alttext_generator_progress';
    
    const getToken = () => { try { return localStorage.getItem(PAT_KEY); } catch { return null; } };
    const saveToken = (t) => { try { localStorage.setItem(PAT_KEY, t); } catch {} };
    const getEndpoint = () => { try { return localStorage.getItem(ENDPOINT_KEY); } catch { return null; } };
    const saveEndpoint = (e) => { try { localStorage.setItem(ENDPOINT_KEY, e); } catch {} };
    const getGeminiKey = () => { try { return localStorage.getItem(GEMINI_KEY); } catch { return null; } };
    const saveGeminiKey = (k) => { try { localStorage.setItem(GEMINI_KEY, k); } catch {} };
    const saveProgress = () => { try { localStorage.setItem(PROGRESS_KEY, JSON.stringify([...completedIds])); } catch(e){} };
    const loadProgress = () => { try { return new Set(JSON.parse(localStorage.getItem(PROGRESS_KEY)) || []); } catch(e){ return new Set(); } };
    const clearProgress = () => { try { localStorage.removeItem(PROGRESS_KEY); completedIds = new Set(); } catch(e){} };
    
    async function gql(query, variables = {}) {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ query, variables })
      });
      const data = await res.json();
      if (data.errors) throw new Error(data.errors[0].message);
      return data.data;
    }
    
    // Fetch image as base64 for Gemini API
    async function fetchImageAsBase64(imageUrl) {
      const response = await fetch(imageUrl);
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
    
    // Generate alt text using Google Gemini 2.0 Flash (FREE)
    async function generateWithGemini(imageUrl) {
      const base64Image = await fetchImageAsBase64(imageUrl);
      
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: 'Generate concise alt text (under 125 characters) for this image. Make it descriptive and useful for screen readers and SEO. Do not start with "Image of" or "A photo of". Return ONLY the alt text, nothing else.' },
                { inlineData: { mimeType: 'image/jpeg', data: base64Image }}
              ]
            }],
            generationConfig: {
              maxOutputTokens: 100,
              temperature: 0.4
            }
          })
        }
      );
      
      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error.message || 'Gemini API error');
      }
      
      if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
        throw new Error('No response from Gemini');
      }
      
      return data.candidates[0].content.parts[0].text.trim();
    }
    
    // Detect what alt text field exists on Asset
    async function detectAltField() {
      try {
        const data = await gql(`{ __type(name: "Asset") { fields { name } } }`);
        const fields = data.__type?.fields?.map(f => f.name) || [];
        console.log('Asset fields:', fields);
        
        const candidates = ['altText', 'alt', 'alternativeText', 'description', 'caption'];
        for (const name of candidates) {
          if (fields.includes(name)) {
            console.log('Found alt field:', name);
            return name;
          }
        }
      } catch (e) {
        console.error('Error detecting alt field:', e);
      }
      return null;
    }
    
    async function fetchAllImages() {
      $('#images-container').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      allImages = [];
      
      altFieldName = await detectAltField();
      console.log('Using alt field:', altFieldName);
      
      if (!altFieldName) {
        $('#no-alt-field-alert').style.display = 'block';
        $('#field-info').textContent = '';
        $('#generate-all-btn').disabled = true;
      } else {
        $('#no-alt-field-alert').style.display = 'none';
        $('#field-info').textContent = `Using field: ${altFieldName}`;
        $('#generate-all-btn').disabled = false;
      }
      
      const altQuery = altFieldName || '';
      const imageMap = new Map(); // Deduplicate by ID
      
      // Fetch from both DRAFT and PUBLISHED stages
      for (const stage of ['DRAFT', 'PUBLISHED']) {
        let hasMore = true, after = null;
        
        while (hasMore) {
          const afterClause = after ? `, after: "${after}"` : '';
          
          const query = `{
            assetsConnection(first: 100${afterClause}, where: { mimeType_starts_with: "image/" }, stage: ${stage}) {
              edges { 
                node { 
                  id 
                  fileName 
                  url 
                  width 
                  height 
                  size 
                  ${altQuery}
                } 
                cursor 
              }
              pageInfo { hasNextPage endCursor }
            }
          }`;
          
          try {
            const data = await gql(query);
            for (const edge of (data.assetsConnection.edges || [])) {
              // Store in map - PUBLISHED version takes priority (has latest alt text)
              if (!imageMap.has(edge.node.id) || stage === 'PUBLISHED') {
                imageMap.set(edge.node.id, edge.node);
              }
            }
            hasMore = data.assetsConnection.pageInfo.hasNextPage;
            after = data.assetsConnection.pageInfo.endCursor;
          } catch (e) {
            console.error(`Error fetching ${stage} images:`, e);
            hasMore = false;
          }
        }
      }
      
      allImages = Array.from(imageMap.values());
      
      console.log('Fetched', allImages.length, 'images');
      
      // Load progress and check if we have a pending bulk operation
      completedIds = loadProgress();
      if (completedIds.size > 0) {
        const remaining = getMissingImages().filter(img => !completedIds.has(img.id));
        if (remaining.length > 0) {
          $('#rate-limit-info').style.display = 'block';
          $('#rate-limit-info').innerHTML = `<strong>üìã Resume Available</strong><br>${completedIds.size} images already processed. ${remaining.length} remaining. <a href="#" id="resume-link" style="color: var(--accent);">Resume generation</a> or <a href="#" id="clear-link" style="color: var(--text-muted);">start fresh</a>`;
          $('#resume-link')?.addEventListener('click', (e) => { e.preventDefault(); generateAllMissing(true); });
          $('#clear-link')?.addEventListener('click', (e) => { e.preventDefault(); clearProgress(); fetchAllImages(); });
        } else {
          clearProgress();
        }
      }
      
      updateStats();
      applyFilter();
    }
    
    function getAltValue(img) {
      if (!altFieldName) return null;
      return img[altFieldName];
    }
    
    function getMissingImages() {
      return allImages.filter(img => {
        const alt = getAltValue(img);
        return !alt || (typeof alt === 'string' && alt.trim() === '');
      });
    }
    
    function updateStats() {
      const missing = getMissingImages().length;
      const hasAlt = allImages.length - missing;
      const coverage = allImages.length > 0 ? Math.round((hasAlt / allImages.length) * 100) : 0;
      
      $('#total-images').textContent = allImages.length;
      $('#missing-alt').textContent = altFieldName ? missing : '-';
      $('#has-alt').textContent = altFieldName ? hasAlt : '-';
      $('#coverage').textContent = altFieldName ? coverage + '%' : '-';
    }
    
    function applyFilter() {
      if (!altFieldName) {
        filteredImages = [...allImages];
      } else if (currentFilter === 'missing') {
        filteredImages = getMissingImages();
      } else if (currentFilter === 'has') {
        filteredImages = allImages.filter(img => {
          const alt = getAltValue(img);
          return alt && (typeof alt !== 'string' || alt.trim() !== '');
        });
      } else {
        filteredImages = [...allImages];
      }
      currentPage = 1;
      renderImages();
      renderPagination();
    }
    
    function renderImages() {
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageImages = filteredImages.slice(start, start + PAGE_SIZE);
      
      if (pageImages.length === 0) {
        $('#images-container').innerHTML = `<div class="empty"><div class="empty-icon">${currentFilter === 'missing' ? 'üéâ' : 'üì∑'}</div><div>${currentFilter === 'missing' ? 'All images have alt text!' : 'No images found'}</div></div>`;
        return;
      }
      
      $('#images-container').innerHTML = `<div class="image-grid">${pageImages.map(img => {
        const altValue = getAltValue(img);
        const hasAltText = altValue && (typeof altValue !== 'string' || altValue.trim());
        
        return `
        <div class="image-card" data-id="${img.id}">
          <img src="${img.url}?width=400" alt="" class="image-preview" loading="lazy" onerror="this.style.display='none'">
          <div class="image-info">
            <div class="image-filename" title="${img.fileName}">${img.fileName}</div>
            <div class="image-meta">${img.width || '?'}√ó${img.height || '?'} ‚Ä¢ ${formatSize(img.size)}</div>
            ${!altFieldName ? `
              <div class="image-status missing">‚ö†Ô∏è No alt field</div>
            ` : hasAltText ? `
              <div class="image-status has-alt">‚úÖ Has alt text</div>
              <div class="alt-preview">${escapeHtml(String(altValue))}</div>
            ` : `
              <div class="image-status missing">‚ö†Ô∏è Missing alt text</div>
              <textarea class="alt-input" placeholder="Enter alt text or click Generate..." data-id="${img.id}"></textarea>
              <div class="image-actions">
                <button class="btn btn-primary btn-sm generate-btn" data-id="${img.id}" data-url="${img.url}">‚ú® Generate</button>
                <button class="btn btn-success btn-sm apply-btn" data-id="${img.id}" style="display:none;">‚úÖ Apply</button>
              </div>
            `}
          </div>
        </div>
      `}).join('')}</div>`;
      
      $$('.generate-btn').forEach(btn => { btn.onclick = () => generateAltText(btn.dataset.id, btn.dataset.url); });
      $$('.apply-btn').forEach(btn => { btn.onclick = () => applyAltText(btn.dataset.id); });
    }
    
    function renderPagination() {
      const totalPages = Math.ceil(filteredImages.length / PAGE_SIZE);
      if (totalPages <= 1) { $('#pagination').innerHTML = ''; return; }
      
      let html = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">‚Üê</button>`;
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += `<span style="color:var(--text-muted)">...</span>`;
        }
      }
      html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">‚Üí</button>`;
      $('#pagination').innerHTML = html;
    }
    
    window.goToPage = function(page) {
      currentPage = page;
      renderImages();
      renderPagination();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    async function generateAltText(imageId, imageUrl) {
      const btn = $(`.generate-btn[data-id="${imageId}"]`);
      const textarea = $(`.alt-input[data-id="${imageId}"]`);
      const applyBtn = $(`.apply-btn[data-id="${imageId}"]`);
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Generating...';
      
      try {
        const altText = await generateWithGemini(imageUrl);
        textarea.value = altText;
        applyBtn.style.display = 'inline-flex';
        showToast('Alt text generated!', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
      
      btn.disabled = false;
      btn.textContent = '‚ú® Generate';
    }
    
    async function applyAltText(imageId) {
      if (!altFieldName) {
        showToast('No alt field on Asset model', 'error');
        return;
      }
      
      const textarea = $(`.alt-input[data-id="${imageId}"]`);
      const applyBtn = $(`.apply-btn[data-id="${imageId}"]`);
      const altText = textarea.value.trim();
      
      if (!altText) { showToast('Please enter alt text first', 'error'); return; }
      
      applyBtn.disabled = true;
      applyBtn.textContent = '‚è≥ Saving...';
      
      try {
        const mutation = `mutation UpdateAssetAlt($id: ID!, $altValue: String!) { 
          updateAsset(where: { id: $id }, data: { ${altFieldName}: $altValue }) { id } 
        }`;
        await gql(mutation, { id: imageId, altValue: altText });
        
        const img = allImages.find(i => i.id === imageId);
        if (img) img[altFieldName] = altText;
        updateStats();
        applyFilter();
        showToast('Alt text saved!', 'success');
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
        applyBtn.disabled = false;
        applyBtn.textContent = '‚úÖ Apply';
      }
    }
    
    function updateProgressModal(current, total, currentFile, startTime) {
      const percent = Math.round((current / total) * 100);
      $('#progress-bar').style.width = percent + '%';
      $('#progress-count').textContent = `${current} / ${total}`;
      $('#progress-percent').textContent = percent + '%';
      $('#progress-current').textContent = currentFile ? `Processing: ${currentFile}` : 'Processing...';
      
      // Calculate ETA
      if (current > 0) {
        const elapsed = (Date.now() - startTime) / 1000;
        const avgTime = elapsed / current;
        const remaining = (total - current) * avgTime;
        const minutes = Math.ceil(remaining / 60);
        $('#progress-eta').textContent = minutes > 1 ? `Estimated time: ~${minutes} minutes` : 'Almost done...';
      }
    }
    
    async function generateAllMissing(resume = false) {
      if (!altFieldName) {
        showToast('No alt field on Asset model', 'error');
        return;
      }
      
      let missing = getMissingImages();
      
      if (resume) {
        missing = missing.filter(img => !completedIds.has(img.id));
      } else {
        clearProgress();
      }
      
      if (missing.length === 0) { 
        showToast('All images have alt text!', 'success'); 
        return; 
      }
      
      const estimatedMinutes = Math.ceil((missing.length * RATE_LIMIT_DELAY) / 60000);
      if (!confirm(`Generate alt text for ${missing.length} images?\n\n‚è±Ô∏è Estimated time: ~${estimatedMinutes} minutes\nüí∞ Cost: FREE (Gemini)\n\nYou can pause and resume anytime.`)) return;
      
      // Show progress modal
      bulkGenerating = true;
      bulkPaused = false;
      bulkCancelled = false;
      $('#progress-modal').style.display = 'flex';
      $('#generate-all-btn').disabled = true;
      $('#pause-btn').textContent = '‚è∏Ô∏è Pause';
      
      const startTime = Date.now();
      let completed = 0;
      
      for (const img of missing) {
        if (bulkCancelled) break;
        
        // Handle pause
        while (bulkPaused && !bulkCancelled) {
          await new Promise(r => setTimeout(r, 100));
        }
        
        if (bulkCancelled) break;
        
        updateProgressModal(completed, missing.length, img.fileName, startTime);
        
        try {
          const altText = await generateWithGemini(img.url);
          const mutation = `mutation UpdateAssetAlt($id: ID!, $altValue: String!) { 
            updateAsset(where: { id: $id }, data: { ${altFieldName}: $altValue }) { id } 
          }`;
          await gql(mutation, { id: img.id, altValue: altText });
          img[altFieldName] = altText;
          completedIds.add(img.id);
          saveProgress();
          completed++;
        } catch (e) {
          console.warn('Error for', img.fileName, e.message);
          // Continue with next image on error
        }
        
        // Rate limiting delay (4 seconds for 15 RPM)
        if (!bulkCancelled && missing.indexOf(img) < missing.length - 1) {
          await new Promise(r => setTimeout(r, RATE_LIMIT_DELAY));
        }
      }
      
      // Hide progress modal
      $('#progress-modal').style.display = 'none';
      bulkGenerating = false;
      $('#generate-all-btn').disabled = false;
      
      if (bulkCancelled) {
        showToast(`Cancelled. ${completed} images processed. Progress saved.`, 'info');
      } else {
        clearProgress();
        showToast(`Generated alt text for ${completed} images!`, 'success');
      }
      
      updateStats();
      applyFilter();
    }
    
    // Pause/Resume button
    $('#pause-btn').onclick = () => {
      bulkPaused = !bulkPaused;
      $('#pause-btn').textContent = bulkPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
    };
    
    // Cancel button
    $('#cancel-btn').onclick = () => {
      bulkCancelled = true;
      bulkPaused = false;
    };
    
    function formatSize(bytes) {
      if (!bytes) return '?';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    $('#connect-btn').onclick = async () => {
      // Get values - endpoint and token may already be set from SDK
      const epInput = $('#endpoint-input').value.trim();
      const tkInput = $('#token-input').value.trim();
      geminiKey = $('#gemini-input').value.trim();
      
      // Use inputs if provided, otherwise use already set values
      if (epInput) endpoint = epInput;
      if (tkInput) token = tkInput;
      
      if (!endpoint || !token || !geminiKey) { 
        $('#setup-error').textContent = 'Please fill all required fields'; 
        // Show hidden fields if needed
        if (!endpoint) $('#endpoint-group').style.display = 'block';
        if (!token) $('#token-group').style.display = 'block';
        return; 
      }
      
      $('#connect-btn').disabled = true;
      $('#connect-btn').textContent = 'Connecting...';
      $('#setup-error').textContent = '';
      
      try {
        // Test Hygraph connection
        await gql('{ __typename }');
        
        // Test Gemini API key
        const testResponse = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: 'Say "OK"' }] }]
            })
          }
        );
        const testData = await testResponse.json();
        if (testData.error) throw new Error('Invalid Gemini API key: ' + testData.error.message);
        
        // Save to shared storage
        if (tkInput) saveToken(tkInput);
        if (epInput) saveEndpoint(epInput);
        saveGeminiKey(geminiKey);
        
        $('#setup-view').style.display = 'none';
        $('#main-view').style.display = 'block';
        fetchAllImages();
      } catch (e) {
        $('#setup-error').textContent = 'Error: ' + e.message;
      }
      
      $('#connect-btn').disabled = false;
      $('#connect-btn').textContent = 'Connect & Scan Images';
    };
    
    $('#refresh-btn').onclick = fetchAllImages;
    $('#generate-all-btn').onclick = () => generateAllMissing(false);
    
    $$('.filter-tab').forEach(tab => {
      tab.onclick = () => {
        $$('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.filter;
        applyFilter();
      };
    });
    
    // Initialize - check SDK and shared storage
    sdk.init({ debug: true })
      .then(async ({ props }) => {
        const sdkEndpoint = props?.context?.environment?.endpoint;
        const sdkAuthToken = props?.context?.environment?.authToken; // NEW: SDK provides auth token!
        const savedToken = getToken();
        const savedEndpoint = getEndpoint();
        const savedGemini = getGeminiKey();
        
        console.log('SDK Auth Token available:', !!sdkAuthToken);
        
        // Auto-set endpoint from SDK
        if (sdkEndpoint) {
          endpoint = sdkEndpoint;
          $('#endpoint-input').value = sdkEndpoint;
          // Hide endpoint field if SDK provides it
        } else if (savedEndpoint) {
          $('#endpoint-input').value = savedEndpoint;
          $('#endpoint-group').style.display = 'block';
        } else {
          $('#endpoint-group').style.display = 'block';
        }
        
        // Prefer SDK auth token, then saved PAT
        const authToken = sdkAuthToken || savedToken;
        if (authToken) {
          token = authToken;
          $('#token-input').value = authToken;
          // If SDK token, save it for future use
          if (sdkAuthToken) {
            localStorage.setItem(PAT_KEY, sdkAuthToken);
            console.log('Stored SDK auth token for other tools');
          }
          // Keep PAT hidden if already saved
        } else {
          $('#token-group').style.display = 'block';
        }
        
        // Load Gemini key
        if (savedGemini) {
          geminiKey = savedGemini;
          $('#gemini-input').value = savedGemini;
        }
        
        // Auto-connect if all credentials are available
        endpoint = sdkEndpoint || savedEndpoint;
        if (endpoint && authToken && savedGemini) {
          token = authToken;
          geminiKey = savedGemini;
          try {
            await gql('{ __typename }');
            $('#setup-view').style.display = 'none';
            $('#main-view').style.display = 'block';
            fetchAllImages();
          } catch (e) {
            // Show token field if auth fails
            $('#token-group').style.display = 'block';
          }
        }
      })
      .catch(() => {
        // Standalone mode - show endpoint field
        const savedToken = getToken();
        const savedEndpoint = getEndpoint();
        const savedGemini = getGeminiKey();
        
        $('#endpoint-group').style.display = 'block';
        if (!savedToken) $('#token-group').style.display = 'block';
        
        if (savedEndpoint) $('#endpoint-input').value = savedEndpoint;
        if (savedToken) $('#token-input').value = savedToken;
        if (savedGemini) $('#gemini-input').value = savedGemini;
      });
  </script>
</body>
</html>
